<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Submitting Exam</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { font-family:"Segoe UI",sans-serif; background:#f1f4f9; }
.cbt-wrapper { max-width:600px; margin:50px auto; background:#fff; padding:30px; border-radius:12px; box-shadow:0 5px 20px rgba(0,0,0,0.1); text-align:center; }
</style>
</head>
<body>

<div class="cbt-wrapper">
  <h3>Submitting your exam...</h3>
  <p id="statusText">Please wait.</p>
  <button id="backBtn" class="btn btn-primary" style="display:none;" onclick="window.location.href = 'dashboard.html';">Back to Dashboard</button>
</div>

<script>
const SUBMIT_API = '/hub/api/exams/submit.php';
const token = localStorage.getItem('token');

// Retrieve exam data from sessionStorage
const examData = JSON.parse(sessionStorage.getItem('examData'));
if (!examData) {
    alert('No exam data found.');
    window.location.href = 'exam_page.html'; // Redirect back to exam page if no data found
}

// Prepare answers for submission: prefer answers stored in sessionStorage (examData.answers)
const answers = {};
if (examData && examData.answers && Object.keys(examData.answers).length) {
    // Values in sessionStorage will already be keyed by question id
    Object.assign(answers, examData.answers);
} else if (examData && examData.questions) {
    // Fallback: attempt to read from DOM (in case of direct submit without storing answers)
    examData.questions.forEach(q => {
        const checked = document.querySelector(`input[name="q_${q.id}"]:checked`);
        if (checked) answers[q.id] = checked.value;
    });
}

// Function to submit exam data to API
async function submitExam() {
    try {
        const res = await fetch(SUBMIT_API, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                exam_id: examData.exam_id,
                answers
            })
        });

        // Get response as text to handle non-JSON output
        const txt = await res.text();
        let data;
        try {
            data = JSON.parse(txt);
        } catch (err) {
            console.error('Invalid JSON from submit API', { status: res.status, body: txt });
            alert('Server error when submitting exam. Check console for details.');
            return;
        }

        if (!data.status) {
            alert(data.message || 'Submission failed');
            return;
        }

        document.getElementById('statusText').innerText = 'Exam submitted successfully!';
        document.getElementById('backBtn').style.display = 'inline-block'; // Show the back button

    } catch (err) {
        console.error('Submit exam error', err);
        alert(err.message || 'Error submitting exam');
    }
}

// Start the submission when page is loaded
submitExam();

</script>

</body>
</html>
