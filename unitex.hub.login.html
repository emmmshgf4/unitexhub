<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UNITEX HUB CBT - Login</title>
<meta name="description" content="UNITEX HUB is a digital learning and innovation platform providing university CBT exam preparation tools and resources for learners in Nigeria. It empowers students and creators with the support, tools, and guidance they need to excel in exams such as JAMB and other university CBT assessments.">
<meta name="keywords" content="UNITEX HUB offers powerful academic performance tools from University CBT, including CGPA and GPA calculators, semester GPA trackers, and comprehensive CGPA analysis. Designed for students, these tools help you monitor and optimize your academic progress throughout university. Developed by Emmanuel Etim, UNITEX HUB empowers learners with practical education tools to track and improve their GPA, plan their semesters, and achieve academic success.">
<meta name="robots" content="index, follow">
<meta name="author" content="UNITEX HUB">

<!--FAVICON-->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css">
<link rel="apple-touch-icon" sizes="180x180" href="http://localhost/hub/frontend/favicon_io/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost/hub/frontend/favicon_io/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost/hub/frontend/favicon_io/favicon-16x16.png">
<link rel="manifest" href="http://localhost/hub/frontend/favicon_io/site.webmanifest">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url" content="">
<meta property="og:image" content="http://localhost/hub/frontend/assets/unitex.png">

<!-- Twitter (X) -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:url" content="">
<meta name="twitter:image" content="http://localhost/hub/frontend/assets/im.png">
   <meta name="msvalidate.01" content="7CFE9C31DF8FDE2D5E752F310DC6AA54" />

   
<link rel="stylesheet" href="css/style.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<script>
    // Apply saved theme early to avoid flash of wrong theme
    (function(){
        const t = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', t);
        if (t === 'light') {
            // body may not exist yet when this script runs in <head>
            if (document.body) document.body.classList.add('light');
            else document.addEventListener('DOMContentLoaded', () => document.body.classList.add('light'));
        }
    })();
</script>
</head>
<body>

<!-- Global error bar (animated slide-down) -->
<div class="error-bar" id="errorBar" aria-live="assertive" style="display:none;">
    <i class="bi bi-exclamation-octagon-fill"></i>
    <div class="error-text" id="errorText">Error: Something went wrong!</div>
    <div class="error-progress" id="errorProgress"></div>
</div>

<!-- Global success bar (animated slide-down) -->
<div class="success-bar" id="successBar" aria-live="polite" style="display:none;">
    <i class="bi bi-check-circle-fill"></i>
    <div class="success-text" id="successText">Success: Your action was completed!</div>
    <div class="success-progress" id="successProgress"></div>
</div>

    <header>
    <div class="header-inner">
        <div class="logo">UNITEX HUB CBT</div>
    </div>
</header>

<div class="theme-toggle">
    <button id="themeToggle" aria-label="Toggle theme">
        <i class="bi bi-moon-fill" id="themeIcon"></i>
    </button>
</div>

<div class="login-container">
    <div class="login-card">
        <h2>UNITEX HUB - CBT</h2>
        <p>Welcome back! Please login to your account.</p>
        <form id="loginForm">
            <div class="input-group">
                <input id="email" type="email" name="email" placeholder="Email" required>
            </div>
            <div class="input-group">
                <input id="password" type="password" name="password" placeholder="Password" required>
            </div>
            <button type="submit" class="login-btn">Login</button>

           


            <div class="signup-link">
                <p>Don't have an account? <a class="signin-btn" href="unitex.hub.signup.html">Sign up</a></p>
            </div>

             <button type="button" id="googleLoginBtn">Login with Google</button>
        </form>
        <div id="loginMsg"></div>
    </div>
</div>

<script src="./js/config.js"></script>
<script src="./js/alerts.js"></script>
<script src="./js/auth.js"></script>
<script src="js/de.js"></script>



<!-- ===== Footer Section ===== -->
<footer class="footer">
  <div class="container footer-container">
    <div class="footer-top">
      <div class="footer-brand">
        <a href="index.html" class="brand">UNITEX HUB</a>
        <p>Empowering Students to Prepare, Practice, and Excel.</p>
      </div>
      <div class="footer-links">
        <div class="footer-column">
          <h4>Quick Links</h4>
          <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="unitex.hub.about.html">About Us</a></li>
            <li><a href="unitex.hub.blog.html">Blog</a></li>
          </ul>
        </div>
        <div class="footer-column">
          <h4>Support</h4>
          <ul>
            <li><a href="unitex.hub.help.html">Help Center</a></li>
            <li><a href="unitex.hub.faq.html">FAQs</a></li>
            <li><a href="unitex.hub,terms.html">Terms & Privacy</a></li>
          </ul>
        </div>
        <div class="footer-column">
          <h4>Follow Us</h4>
          <ul class="social-links">
            <li><a href="https://web.facebook.com/people/Unitex-Hub-Learn-Smarter/61582938541876/" target="_blank">Facebook</a></li>
            <li><a href="https://x.com/Unitexhub2025?s=21" target="_blank">Twitter</a></li>
            <li><a href="https://www.instagram.com/unitexhub2025?igsh=MXFuZHBzOWJtcm5jdw%3D%3D&utm_source=qr" target="_blank">Instagram</a></li>
            <li><a href="#" target="_blank">LinkedIn</a></li>
          </ul>
        </div>
      </div>
    </div>
    <div class="footer-bottom">
      <p>&copy; <?= date('Y') ?> UNITEX HUB. All Rights Reserved.</p>
    </div>
  </div>
</footer>

<!-- ===== Footer CSS ===== -->
<style>
.footer {
  background-color: var(--color-dark-400);
  color: var(--color-gray-100);
  padding: 4rem 0 2rem;
  font-size: 0.9rem;
}
.footer a {
  color: var(--color-gray-100);
  text-decoration: none;
  transition: color 0.3s ease;
}
.footer a:hover {
  color: var(--color-blue-300);
}
.footer-container {
  max-width: 75rem;
  margin: 0 auto;
  padding: 0 1.5rem;
}
.footer-top {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  gap: 2rem;
  margin-bottom: 2rem;
}
.footer-brand {
  flex: 1 1 20rem;
}
.footer-brand p {
  margin-top: 0.5rem;
  line-height: 1.5;
}
.footer-links {
  display: flex;
  flex: 2 1 40rem;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 2rem;
}
.footer-column h4 {
  font-weight: 600;
  margin-bottom: 0.75rem;
  color: var(--color-blue-300);
}
.footer-column ul {
  list-style: none;
  padding: 0;
}
.footer-column ul li {
  margin-bottom: 0.5rem;
}
.social-links li {
  display: inline-block;
  margin-right: 0.5rem;
}
.footer-bottom {
  text-align: center;
  border-top: 1px solid rgba(255,255,255,0.1);
  padding-top: 1rem;
}
@media (max-width: 768px) {
  .footer-top {
    flex-direction: column;
    align-items: center;
    text-align: center;
  }
  .footer-links {
    flex-direction: column;
    gap: 1.5rem;
  }
  .social-links li {
    display: inline-block;
    margin-right: 1rem;
  }
}
</style>

<script type="module">
  // Import Firebase app + auth and initialize the app first
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAuth, signInWithPopup, signInWithRedirect, getRedirectResult, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
  import firebaseConfig from './js/firebase.config.js';

  // Initialize Firebase app (required before calling getAuth)
  const loginBtn = document.getElementById('googleLoginBtn');
  let auth;
    try {
    const app = initializeApp(firebaseConfig);
    auth = getAuth(app); // Get the auth instance
    const provider = new GoogleAuthProvider(); // Google provider

    // Handle redirect result (in case we fell back to redirect flow)
    getRedirectResult(auth).then(async (result) => {
      if (result && result.user) {
        const user = result.user;
        console.log('Redirect result user:', user);
        await handleSocialUser(user);
      }
    }).catch(err => {
      console.warn('getRedirectResult error', err);
    });

    loginBtn.addEventListener('click', async () => {
      try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        console.log("User info:", user);
        await handleSocialUser(user);

      } catch (error) {
        console.error("Login error:", error);
        // If popup is blocked/failed or internal assertion occurs, fallback to redirect flow
        const code = error && error.code ? error.code : '';
        const message = error && error.message ? error.message : '';
        const shouldFallback = code === 'auth/popup-blocked' || code === 'auth/popup-closed-by-user' || code === 'auth/cancelled-popup-request' || /Pending promise was never set/.test(message) || /popup/i.test(message);
        if (shouldFallback) {
          // Inform user and fallback
          if (typeof showError === 'function') showError('Popup blocked or closed; switching to redirect sign-in...', 3000);
          else alert('Popup blocked or closed; switching to redirect sign-in...');
          try {
            await signInWithRedirect(auth, provider);
            return;
          } catch (redirErr) {
            console.error('Redirect fallback failed', redirErr);
            alert('Redirect sign-in failed: ' + (redirErr && redirErr.message ? redirErr.message : redirErr));
            return;
          }
        }

        alert("Login failed: " + (error && error.message ? error.message : error));
      }
    });
  } catch (err) {
    console.error('Firebase initialization error:', err);
    // Show a friendly error bar with guidance
    const errBar = document.getElementById('errorBar');
    const errText = document.getElementById('errorText');
    errText.textContent = 'Firebase initialization failed: ' + (err && err.message ? err.message : err);
    errBar.style.display = 'flex';
    // disable login button to avoid confusing errors
    if (loginBtn) loginBtn.disabled = true;
    // Add a short actionable hint
    const hint = document.createElement('div');
    hint.style.marginTop = '8px';
    hint.style.fontSize = '0.9rem';
    hint.style.opacity = '0.9';
    hint.textContent = 'Check Firebase API key, Authorized domains (include localhost), and enable Google Sign-in in Firebase Console.';
    errBar.appendChild(hint);
  }

  // Shared handler for user after popup/redirect
  async function handleSocialUser(user) {
    const payload = {
      email: user.email,
      name: user.displayName || '',
      photo: user.photoURL || ''
    };

    // Post to backend; provide detailed diagnostics on failure
    let res;
    try {
      res = await fetch(API_URL + 'auth/social_login.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
    } catch (fetchErr) {
      console.error('Network error posting to social_login:', fetchErr);
      alert('Login failed: Network error when contacting server. Check that backend is running and reachable.');
      return;
    }

    if (!res.ok) {
      const bodyText = await res.text().catch(() => null);
      console.error('social_login returned non-OK status', res.status, bodyText);
      alert('Login failed: server returned ' + res.status + (bodyText ? ' - ' + bodyText : ''));
      return;
    }

    let data;
    try {
      data = await res.json();
    } catch (jsonErr) {
      const txt = await res.text().catch(() => null);
      console.error('Failed to parse JSON from social_login:', jsonErr, txt);
      alert('Login failed: Invalid response from server.' + (txt ? '\n' + txt : ''));
      return;
    }

    if (!data.status) {
      const err = data.message || 'Social login failed';
      console.error('Social login error:', err, data);
      alert('Login failed: ' + err);
      return;
    }

    const token = data.token || data.data?.token || data.data?.token;
    if (!token) {
      alert('Login failed: No token returned');
      return;
    }

    const payloadJWT = parseJWT(token);
    if (!payloadJWT) {
      alert('Login failed: Invalid token');
      return;
    }

    const role = payloadJWT.role || payloadJWT.user?.role || 'user';
    if (role === 'admin') {
      localStorage.setItem('adminToken', token);
      if (typeof showSuccess === 'function') { showSuccess('Login successful', 1000); setTimeout(()=>window.location.href='admin/dashboard.html', 1200); }
      else window.location.href = 'admin/dashboard.html';
    } else {
      localStorage.setItem('token', token);
      if (typeof showSuccess === 'function') { showSuccess('Login successful', 1000); setTimeout(()=>window.location.href='dashboard.html', 1200); }
      else window.location.href = 'dashboard.html';
    }
  }
</script>



</body>
</html>
