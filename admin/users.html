<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin â€“ Users</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">
  <h3 class="mb-4">Users (Admin)</h3>

  <div class="card mb-3">
    <div class="card-body">
      <div class="d-flex mb-2">
        <input id="q" class="form-control me-2" placeholder="Search by username or email">
        <button id="refreshBtn" class="btn btn-primary">Refresh</button>
      </div>
      <div class="table-responsive">
        <table class="table table-sm table-striped table-bordered">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Avatar</th>
              <th>Username</th>
              <th>Email</th>
              <th>Role</th>
              <th>Premium</th>
              <th>Created</th>
              <th>Last Login</th>
            </tr>
          </thead>
          <tbody id="usersTbody"></tbody>
        </table>
      </div>
      <div id="usersMsg" class="small text-muted mt-2"></div>
    </div>
  </div>

</div>

<script>
// Admin-only users listing
const API = '/hub/api';
const token = localStorage.getItem('adminToken');
if (!token) { window.location.href = '/hub/frontend/index.html'; }

const headers = { 'Content-Type': 'application/json' };
if (token) headers.Authorization = 'Bearer ' + token;

async function loadUsers(){
  const tbody = document.getElementById('usersTbody');
  const msg = document.getElementById('usersMsg');
  tbody.innerHTML = '';
  msg.innerText = '';

  try{
    const res = await fetch(API + '/users/list.php?limit=1000', { headers });
    if (res.status === 401 || res.status === 403) { localStorage.removeItem('adminToken'); window.location.href = '/hub/frontend/index.html'; return; }
    const data = await res.json();
    if (!data || data.status === false) { msg.innerText = data?.message || 'Failed to load users'; return; }
    if (!Array.isArray(data.data) || data.data.length === 0) { msg.innerText = 'No users found'; return; }

    data.data.forEach(u => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${u.id}</td>
        <td><img src="/hub/uploads/profile_pics/${u.profile_pic || 'default.png'}" style="width:36px;height:36px;object-fit:cover;border-radius:6px"></td>
        <td>${u.username || ''}</td>
        <td>${u.email || ''}</td>
        <td>${u.role || ''}</td>
        <td>${u.is_premium ? 'Yes' : 'No'}</td>
        <td>${u.created_at || ''}</td>
        <td>${u.last_login || ''}</td>
      `;
      tbody.appendChild(tr);
    });

  } catch(err){
    console.error('loadUsers error', err);
    document.getElementById('usersMsg').innerText = 'Network or server error';
  }
}

// Basic admin check + initial load
(async function ensureAdmin(){
  try{
    const r = await fetch(API + '/rooms/list.php', { headers: { 'Authorization': 'Bearer ' + token } });
    if (!r.ok) { localStorage.removeItem('adminToken'); window.location.href = '/hub/frontend/index.html'; return; }
    const d = await r.json();
    if (!d || d.status === false) { localStorage.removeItem('adminToken'); window.location.href = '/hub/frontend/index.html'; return; }
    loadUsers();
  } catch(e){ localStorage.removeItem('adminToken'); window.location.href = '/hub/frontend/index.html'; }
})();

document.getElementById('refreshBtn').addEventListener('click', loadUsers);

</script>

</body>
</html>
