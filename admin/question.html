<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin – Manage Questions</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>

<body class="bg-light">
<div class="container py-4">

  <h3 class="mb-4">Manage Exam Questions</h3>

  <!-- ROOM SELECT -->
  <div class="mb-4">
    <label class="form-label">Select Room</label>
    <select id="roomSelect" class="form-select"></select>
  </div>

  <!-- ADD SINGLE QUESTION -->
  <div class="card mb-4">
    <div class="card-header">Add Single Question</div>
    <div class="card-body">
      <form id="singleQuestionForm">
        <textarea class="form-control mb-3" name="question_text" placeholder="Question text" required></textarea>

        <input class="form-control mb-2" name="A" placeholder="Option A" required>
        <input class="form-control mb-2" name="B" placeholder="Option B" required>
        <input class="form-control mb-2" name="C" placeholder="Option C" required>
        <input class="form-control mb-2" name="D" placeholder="Option D" required>

        <input class="form-control mb-2" name="correct_answer" placeholder="Correct Answer (A/B/C/D)" required>

        <textarea class="form-control mb-3" name="explanation" placeholder="Explanation (optional)"></textarea>

        <button class="btn btn-primary">Add Question</button>
      </form>
    </div>
  </div>

  <!-- CSV UPLOAD -->
  <div class="card mb-4">
    <div class="card-header">Upload Questions (CSV)</div>
    <div class="card-body">
      <input type="file" id="csvFile" class="form-control mb-2" accept=".csv">
      <button class="btn btn-success" onclick="uploadCSV()">Upload CSV</button>
    </div>
  </div>

  <!-- QUESTION LIST -->
  <div class="card">
    <div class="card-header">Questions</div>
    <div class="card-body">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>#</th>
            <th>Question</th>
            <th>Correct</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="questionTable"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
const API = "/hub/api";
const token = localStorage.getItem("adminToken");

// Build headers object and ensure Authorization uses Bearer prefix when present
const headers = { "Content-Type": "application/json" };
if (token) headers.Authorization = 'Bearer ' + token;

// Protect admin page: redirect non-admins to public index
(async function ensureAdmin(){
  if (!token) { window.location.href = '/hub/frontend/index.html'; return; }
  try {
    const res = await fetch(API + '/rooms/list.php', { headers: { 'Authorization': 'Bearer ' + token } });
    if (!res.ok) { localStorage.removeItem('adminToken'); window.location.href = '/hub/frontend/index.html'; return; }
    const data = await res.json();
    if (!data || data.status === false) { localStorage.removeItem('adminToken'); window.location.href = '/hub/frontend/index.html'; return; }
    // valid admin — proceed to load the page
    loadRooms();
  } catch (err) {
    console.error('Admin token validation failed', err);
    localStorage.removeItem('adminToken');
    window.location.href = '/hub/frontend/index.html';
  }
})();

async function loadRooms() {
  try {
    const res = await fetch(API + "/rooms/list.php", { headers });
    const data = await res.json();

    console.log("ROOM API RESPONSE:", data);

    // VALIDATION
    if (!data.status || !data.data || !Array.isArray(data.data.rooms)) {
      console.error("Rooms API error:", data);
      alert("Failed to load rooms");
      return;
    }

    const rooms = data.data.rooms;

    const select = document.getElementById("roomSelect");
    select.innerHTML = "";

    rooms.forEach(room => {
      const opt = document.createElement("option");
      opt.value = room.id;
      opt.textContent = room.name;
      select.appendChild(opt);
    });

    // Load questions for first room
    if (rooms.length > 0) {
      loadQuestions();
    }

  } catch (err) {
    console.error("Network or parsing error:", err);
    alert("Network error while loading rooms");
  }
}

// loadRooms() is now invoked from ensureAdmin() after validation
/* ---------- ADD SINGLE QUESTION ---------- */
document.getElementById("singleQuestionForm").addEventListener("submit", async e => {
  e.preventDefault();

  const f = e.target;

  const payload = {
    room_id: roomSelect.value,
    question_text: f.question_text.value,
    options: {
      A: f.A.value,
      B: f.B.value,
      C: f.C.value,
      D: f.D.value
    },
    correct_answer: f.correct_answer.value,
    explanation: f.explanation.value
  };

  const res = await fetch(API + "/t_questions/add_single.php", {
    method: "POST",
    headers,
    body: JSON.stringify(payload)
  });

  const data = await res.json();
  alert(data.message || "Saved");
  f.reset();
  loadQuestions();
});

/* ---------- UPLOAD CSV ---------- */
async function uploadCSV() {
  const file = document.getElementById("csvFile").files[0];
  if (!file) return alert("Select CSV file");

  const fd = new FormData();
  fd.append("csv", file);
  fd.append("room_id", roomSelect.value);

  const res = await fetch(API + "/t_questions/upload_csv.php", {
    method: "POST",
    headers: { "Authorization": token },
    body: fd
  });

  const data = await res.json();
  alert(data.message || "Upload complete");
  loadQuestions();
}

/* ---------- LOAD QUESTIONS ---------- */
async function loadQuestions() {
  try {
    const res = await fetch(API + "/t_questions/list.php?room_id=" + roomSelect.value, { headers });
    const data = await res.json();

    const tbody = document.getElementById("questionTable");
    tbody.innerHTML = "";

    if (!Array.isArray(data.data)) {
      tbody.innerHTML = `
        <tr>
          <td colspan="4" class="text-center text-muted">No questions found</td>
        </tr>`;
      return;
    }

    data.data.forEach((q, i) => {
      tbody.innerHTML += `
        <tr>
          <td>${i + 1}</td>
          <td>${q.question_text}</td>
          <td>${q.correct_answer}</td>
          <td>
            <button class="btn btn-danger btn-sm" onclick="deleteQuestion(${q.id})">Delete</button>
          </td>
        </tr>
      `;
    });
  } catch (err) {
    console.error(err);
    alert("Error loading questions");
  }
}

/* ---------- DELETE QUESTION ---------- */
async function deleteQuestion(id) {
  if (!confirm("Delete this question?")) return;

  const res = await fetch(API + "/t_questions/delete.php?id=" + id, {
    method: "DELETE",
    headers
  });

  const data = await res.json();
  alert(data.message || "Deleted");
  loadQuestions();
}

document.getElementById("roomSelect").addEventListener("change", loadQuestions);

loadRooms();
</script>
</body>
</html>
