<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Create Room - Admin</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body class="bg-light">
<div class="container py-4">
  <h2>Create Exam Room</h2>

  <!-- Room Form -->
  <form id="roomForm">
    <div class="mb-3">
      <label>Name</label>
      <input type="text" class="form-control" name="name" required>
    </div>
    <div class="mb-3">
      <label>Description</label>
      <textarea class="form-control" name="description"></textarea>
    </div>
    <div class="mb-3">
      <label>Duration (minutes)</label>
      <input type="number" class="form-control" name="duration" value="30" min="10" max="30" required>
    </div>
    <div class="mb-3">
      <label>Exam Type</label>
      <select class="form-select" name="exam_type">
        <option value="free">Free</option>
        <option value="premium">Premium</option>
      </select>
    </div>
    <div class="mb-3">
      <label>Exam Password</label>
      <input type="text" class="form-control" name="exam_password">
    </div>
    <button type="submit" class="btn btn-primary">Create Room</button>
  </form>

  <div id="result" class="mt-3"></div>

  <hr>

  <div class="mb-3 d-flex gap-2 align-items-center">
    <label for="roomSelect" class="mb-0">Download submissions for:</label>
    <select id="roomSelect" class="form-select w-auto">
      <option value="">All rooms</option>
    </select>
    <button id="downloadPdf" class="btn btn-primary"><i class="bi bi-download"></i> Download Submissions (PDF)</button>
    <div id="downloadStatus" class="ms-2 text-muted"></div>
  </div>

  <!-- Rooms List -->
  <h3>All Rooms</h3>
  <table class="table table-bordered mt-3">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Description</th>
        <th>Duration</th>
        <th>Type</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="roomsTableBody">
      <!-- Rooms will populate here -->
    </tbody>
  </table>

</div>

<script>
// --- Create Room ---
const form = document.getElementById("roomForm");
// Ensure admin: redirect non-admins to public index
(async function ensureAdmin(){
  const token = localStorage.getItem('adminToken');
  if (!token) { window.location.href = '/hub/frontend/index.html'; return; }
  try {
    const res = await fetch('/hub/api/rooms/list.php', { headers: { 'Authorization': 'Bearer ' + token } });
    if (!res.ok) { localStorage.removeItem('adminToken'); window.location.href = '/hub/frontend/index.html'; return; }
    const data = await res.json();
    if (!data || data.status === false) { localStorage.removeItem('adminToken'); window.location.href = '/hub/frontend/index.html'; return; }
    // valid admin â€” proceed to load rooms
    fetchRooms();
  } catch (err) {
    console.error('Admin token validation failed', err);
    localStorage.removeItem('adminToken');
    window.location.href = '/hub/frontend/index.html';
  }
})();

form.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const formData = Object.fromEntries(new FormData(form));
  const token = localStorage.getItem("adminToken"); // JWT from login
  try{
    const res = await fetch("/hub/api/rooms/create.php", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
      body: JSON.stringify(formData)
    });
    const data = await res.json();
    document.getElementById("result").innerText = data.message;
    if(data.status) {
      form.reset();
      fetchRooms(); // refresh rooms list
    }
  } catch(err){ console.error(err); }
});

// --- Fetch Rooms ---
async function fetchRooms() {
  const token = localStorage.getItem("adminToken");
  try {
    const res = await fetch("/hub/api/rooms/list.php", {
      headers: { "Authorization": "Bearer " + token }
    });
    const data = await res.json();

    const rooms = data.data.rooms || [];
    const tableBody = document.getElementById("roomsTableBody");
    tableBody.innerHTML = "";

    if (rooms.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="6">No rooms found</td></tr>`;
      return;
    }

    rooms.forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.id}</td>
        <td>${r.name}</td>
        <td>${r.description}</td>
        <td>${r.duration}</td>
        <td>${r.exam_type}</td>
        <td>
          <button class="btn btn-sm btn-warning" onclick="editRoom(${r.id})">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="deleteRoom(${r.id})">Delete</button>
        </td>
      `;
      tableBody.appendChild(tr);
    });
    // populate room selector for downloads
    const roomSelect = document.getElementById('roomSelect');
    if(roomSelect){
      roomSelect.innerHTML = '<option value="">All rooms</option>';
      rooms.forEach(r=>{
        const opt = document.createElement('option'); opt.value = r.id; opt.textContent = r.name; roomSelect.appendChild(opt);
      });
    }

  } catch(err) {
    console.error(err);
  }
}

// --- Delete Room ---
async function deleteRoom(id) {
  if (!confirm("Are you sure you want to delete this room?")) return;
  const token = localStorage.getItem("adminToken");
  try {
    const res = await fetch(`/hub/api/rooms/delete.php?id=${id}`, {
      method: "DELETE",
      headers: { "Authorization": "Bearer " + token }
    });
    const data = await res.json();
    alert(data.message);
    if (data.status) fetchRooms();
  } catch(err) { console.error(err); }
}

// --- Edit Room ---
function editRoom(id) {
  // For simplicity, you can redirect to a separate edit page
  window.location.href = `/hub/api/rooms/get.php?id=${id}`;
}

// Fetch rooms on page load
fetchRooms();

// Download submissions button
document.getElementById('downloadPdf').addEventListener('click', async function(){
  const status = document.getElementById('downloadStatus');
  const roomId = document.getElementById('roomSelect').value;
  status.innerText = 'Preparing...';
  try{
    const token = localStorage.getItem('adminToken') || '';
    const url = '/hub/api/exams/download_submissions.php' + (roomId ? ('?room_id=' + encodeURIComponent(roomId)) : '');
    const res = await fetch(url, { method: 'GET', headers: { 'Authorization': 'Bearer ' + token } });
    if(!res.ok){ const txt = await res.text(); status.innerHTML = 'Error: '+txt; return; }
    const blob = await res.blob();
    const a = document.createElement('a');
    const u = URL.createObjectURL(blob);
    a.href = u; a.download = roomId ? `submissions_room_${roomId}.pdf` : 'submissions.pdf'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(u);
    status.innerHTML = 'Download started.';
  }catch(e){ console.error(e); status.innerHTML = 'Error preparing PDF'; }
});
</script>

</body>
</html>
