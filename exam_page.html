<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exam Page</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
html, body {
  margin:0;
  padding:0;
  font-family:"Segoe UI", sans-serif;
  background:#f1f4f9;
}

/* ===== REMOVE CARD LOOK ===== */
.cbt-wrapper {
  width:100%;
  min-height:100vh;
  background:#fff;
  display:flex;
  flex-direction:column;
}

/* ===== HEADER ===== */
header {
  background:#004aad;
  color:#fff;
  padding:20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.timer {
  font-size:16px;
  background:rgba(255,255,255,0.2);
  padding:8px 14px;
  border-radius:20px;
  font-weight:bold;
}

/* ===== QUESTIONS ===== */
#questionsContainer {
  flex:1;
  padding:30px 20px;
}

.question-box {
  display:none;
  max-width:900px;
  margin:0 auto;
  font-size:18px;
}

.question-box.active {
  display:block;
}

/* Disable copy */
.question-box,
.question-box * {
  user-select:none;
  -webkit-user-select:none;
  -moz-user-select:none;
  -ms-user-select:none;
}

.options label {
  display:block;
  margin:12px 0;
  font-size:16px;
  cursor:pointer;
}

input[type="radio"] {
  margin-right:10px;
  transform:scale(1.2);
}

/* ===== CONTROLS ===== */
.controls {
  padding:20px;
  border-top:1px solid #ddd;
  display:flex;
  justify-content:center;
  gap:12px;
  flex-wrap:wrap;
}

/* ===== QUESTION PALETTE ===== */
.question-palette {
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  justify-content:center;
  padding-bottom:20px;
}

.question-palette button {
  width:40px;
  height:40px;
  border-radius:50%;
  border:2px solid #0d6efd;
  background:#fff;
  color:#0d6efd;
  font-weight:bold;
  cursor:pointer;
  transition:.3s;
}

.question-palette button.active {
  border-color:#004aad;
  transform:scale(1.1);
}

.question-palette button.answered {
  background:#198754;
  color:#fff;
  border-color:#198754;
}

.question-palette button.skipped {
  background:#dc3545;
  color:#fff;
  border-color:#dc3545;
}

/* ===== SUBMITTED MESSAGE ===== */
.submitted-message-container {
  background:#ffdddd;
  padding:20px;
  border-radius:8px;
  margin:40px auto;
  text-align:center;
  box-shadow:0 4px 8px rgba(0,0,0,0.1);
  max-width:400px;
}

.go-back-button {
  margin-top:15px;
  padding:10px 20px;
  background:#4CAF50;
  color:white;
  border:none;
  border-radius:5px;
  cursor:pointer;
}

.go-back-button:hover {
  background:#45a049;
}

/* ===== WATERMARK ===== */
body::before {
  content:"UNITEX HUB CBT";
  position:fixed;
  top:50%;
  left:50%;
  font-size:50px;
  color:rgba(255,0,0,0.15);
  transform:translate(-50%,-50%) rotate(-30deg);
  pointer-events:none;
  z-index:9999;
  white-space:nowrap;
}
</style>
</head>

<body>

<div class="cbt-wrapper">
<header>
  <h3 id="examTitle">Loading Exam...</h3>
  <div class="timer" id="timer">00:00</div>
</header>

<form id="examForm">
  <input type="hidden" name="exam_id" id="exam_id">
  <div id="questionsContainer"></div>
  <div class="question-palette" id="questionPalette"></div>

  <div class="controls">
    <button type="button" class="btn btn-primary" id="prevBtn" style="display:none;">Previous</button>
    <button type="button" class="btn btn-primary" id="nextBtn" style="display:none;">Next</button>
    <button type="button" class="btn btn-success" id="submitBtn" style="display:none;">Submit Exam</button>
  </div>
</form>
</div>

<!-- ===== ANTI COPY ===== -->
<script>
document.addEventListener('contextmenu', e => {
  if (e.target.closest('.question-box')) e.preventDefault();
});
document.addEventListener('copy', e => {
  if (e.target.closest('.question-box')) {
    e.preventDefault();
    alert("Copying exam questions is disabled!");
  }
});
</script>

<script>
const API = '/hub/api/exams/get_questions.php';
const token = localStorage.getItem('token');

// Debug helpers: log page load, token and room_id; capture global errors
const debugRoomId = new URLSearchParams(window.location.search).get('room_id');
console.log('Exam page loaded', { room_id: debugRoomId, tokenPresent: !!token });
window.addEventListener('error', (e) => {
    console.error('Unhandled error', e.error || e.message, e);
});
window.addEventListener('unhandledrejection', (e) => {
    console.error('Unhandled rejection', e.reason);
});

if(!token){
    alert('Please login first');
    window.location.href='login.html';
}

let examData = null;
let current = 0;
let duration = 0;
const questionsContainer = document.getElementById('questionsContainer');
const questionPalette = document.getElementById('questionPalette');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const submitBtn = document.getElementById('submitBtn');
const timerEl = document.getElementById('timer');

// Function to check if the user has already submitted the exam
async function checkIfAlreadySubmitted(examId) {
    try {
        const response = await fetch(`/hub/api/exams/check_submission.php?exam_id=${examId}`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        const result = await response.json();
        return result.submitted || false;
    } catch (err) {
        console.error('Error checking submission:', err);
        return false;
    }
}

function getRoomId(){
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('room_id');
}

function renderQuestions(){
    questionsContainer.innerHTML = '';
    examData.questions.forEach((q, index) => {
        const div = document.createElement('div');
        div.className = 'question-box';
        div.dataset.index = index;
        div.innerHTML = `
            <h5>Q${index + 1}. ${q.question}</h5>
            <div class="options">
                <label><input type="radio" name="q_${q.id}" value="A"> ${q.option_a}</label>
                <label><input type="radio" name="q_${q.id}" value="B"> ${q.option_b}</label>
                <label><input type="radio" name="q_${q.id}" value="C"> ${q.option_c}</label>
                <label><input type="radio" name="q_${q.id}" value="D"> ${q.option_d}</label>
            </div>
        `;
        questionsContainer.appendChild(div);
    });
}

function renderPalette(){
    questionPalette.innerHTML = '';
    examData.questions.forEach((q, index) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.dataset.index = index;
        btn.innerText = index + 1;
        btn.addEventListener('click', () => { showQuestion(index); });
        questionPalette.appendChild(btn);
    });
}

function updatePalette(){
    const qBtns = questionPalette.querySelectorAll('button');
    qBtns.forEach((btn, index) => {
        btn.classList.remove('active', 'answered', 'skipped');
        if (index === current) btn.classList.add('active');
        const qDiv = questionsContainer.querySelector(`.question-box[data-index="${index}"]`);
        const checked = qDiv.querySelector('input[type="radio"]:checked');
        if (checked) btn.classList.add('answered');
        else btn.classList.add('skipped');
    });
}

function showQuestion(i){
    const qBoxes = document.querySelectorAll('.question-box');
    qBoxes.forEach((q, idx) => q.classList.toggle('active', idx === i));
    current = i;
    prevBtn.style.display = i === 0 ? 'none' : 'inline-block';
    nextBtn.style.display = i === qBoxes.length - 1 ? 'none' : 'inline-block';
    submitBtn.style.display = i === qBoxes.length - 1 ? 'inline-block' : 'none';
    updatePalette();
}

function startTimer(){
    function tick(){
        let m = Math.floor(duration / 60), s = duration % 60;
        timerEl.innerText = m + ':' + (s < 10 ? '0' : '') + s;
        if (duration <= 0) { submitExam(); }
        else { duration--; setTimeout(tick, 1000); }
    }
    tick();
}

nextBtn.addEventListener('click', () => { if (current < examData.questions.length - 1) showQuestion(current + 1); });
prevBtn.addEventListener('click', () => { if (current > 0) showQuestion(current - 1); });
// Collect answers from DOM and store them in sessionStorage, then redirect to submit page
function collectAnswers() {
    const answers = {};
    if (!examData || !examData.questions) return answers;
    examData.questions.forEach(q => {
        const checked = document.querySelector(`input[name="q_${q.id}"]:checked`);
        if (checked) answers[q.id] = checked.value;
    });
    return answers;
}

async function submitExam() {
    // collect answers and attach to examData copy
    const copy = Object.assign({}, examData);
    copy.answers = collectAnswers();
    sessionStorage.setItem('examData', JSON.stringify(copy));
    // navigate to submission handler page
    window.location.href = 'submit.html';
}

submitBtn.addEventListener('click', submitExam);

async function loadExam() {
    try {
        const roomId = getRoomId();
        console.log('Loading exam for room_id=', roomId);

        const res = await fetch(`${API}?room_id=${roomId}`, {
            headers: { 'Authorization': 'Bearer ' + token }
        });

        const txt = await res.text();
        let data;
        try {
            data = JSON.parse(txt);
        } catch (err) {
            console.error('Invalid JSON response from API', { status: res.status, body: txt });
            alert('Server returned invalid response. Check console (F12) for details.');
            return;
        }

        if (!data.status) {
            // Special handling when user previously submitted: show in-page message and update title
            if (data.data && data.data.submitted) {
                // Update title (avoid leaving the "Loading Exam..." text)
                const roomName = (data.data.room && data.data.room.name) ? data.data.room.name : 'Exam';
                document.getElementById('examTitle').innerText = `${roomName} — Submitted`;

                // Replace content of the wrapper with a friendly message (keeps header visible)
                const wrapper = document.querySelector('.cbt-wrapper');
                if (wrapper) {
                    wrapper.innerHTML = `
                        <header><h3 id="examTitle">${roomName} — Submitted</h3></header>
                        <div class="submitted-message-container">
                            <p>You have already submitted this exam. Please wait for results.</p>
                            <button class="go-back-button">Go Back to Dashboard</button>
                        </div>
                    `;
                    const btn = wrapper.querySelector('.go-back-button');
                    if (btn) btn.addEventListener('click', () => window.location.href = 'dashboard.html');
                }
                return;
            }

            alert(data.message || 'Failed to fetch exam');
            return;
        }

        examData = data.data;
        duration = examData.room.duration * 60;
        document.getElementById('examTitle').innerText = examData.room.name + ' Exam';
        document.getElementById('exam_id').value = examData.exam_id;

        // Check if the user has already submitted
        const isSubmitted = await checkIfAlreadySubmitted(examData.exam_id);
        if (isSubmitted) {
            const container = document.createElement('div');
            container.className = 'submitted-message-container';
            container.innerHTML = `
                <p>You have already submitted this exam. Please wait for results.</p>
                <button class="go-back-button">Go Back to Dashboard</button>
            `;
            document.body.appendChild(container);

            const button = container.querySelector('.go-back-button');
            button.addEventListener('click', () => {
                window.location.href = 'dashboard.html';
            });
            return;  // Stop further processing if already submitted
        }

        renderQuestions();
        renderPalette();
        showQuestion(0);
        startTimer();
    } catch (e) {
        console.error('Error loading exam', e);
        alert(e.message || 'Error loading exam (see console)');
    }
}

loadExam();

</script>

</body>
</html>
